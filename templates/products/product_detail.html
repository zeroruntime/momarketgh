{% extends 'base.html' %}

{% block title %}{{ product.crop_name }} - MoMarket GH{% endblock %}

{% load custom_filters %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="md:flex">
            <div class="md:w-1/2">
                {% if product.photos.all %}
                    <div class="grid grid-cols-1 gap-4">
                        {% for photo in product.photos.all %}
                            {% with photo_url=photo.photo.url %}
                                {% if photo_url|lower|endswith:".mp4" or photo_url|lower|endswith:".webm" or photo_url|lower|endswith:".ogg" %}
                                    <video controls class="w-full h-auto object-cover object-center rounded">
                                        <source src="{{ photo_url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <img src="{{ photo_url }}" alt="{{ product.crop_name }}" class="w-full h-auto object-cover object-center rounded" />
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                <div class="w-full h-full bg-gray-200 flex items-center justify-center" style="min-height: 300px;">
                    <span class="text-gray-500 text-6xl">üåæ</span>
                </div>
                {% endif %}
            </div>
            <div class="md:w-1/2 p-6">
                <div class="flex justify-between items-start">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ product.crop_name }}</h1>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ product.created_at|date:"F d, Y" }}</span>
                </div>

                <div class="flex items-center mb-4">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-gray-500 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-500">{{ product.region }}, {{ product.location }}</span>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div>
                        <span class="text-2xl font-bold text-green-700">‚Çµ{{ product.price_per_unit }}</span>
                        <span class="text-gray-500">per {{ product.unit }}</span>
                    </div>
                    <div>
                        <span class="text-lg font-semibold">{{ product.quantity }} {{ product.unit }}</span>
                        <span class="text-gray-500">available</span>
                    </div>
                </div>

                <div class="border-t border-b border-gray-200 py-4 mb-4">
                    <h3 class="text-lg font-semibold mb-2">Description</h3>
                    <p class="text-gray-700">{{ product.description }}</p>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Seller Information</h3>
                    <div class="flex items-center">
                        <div class="h-12 w-12 rounded-full bg-green-100 flex items-center justify-center text-xl mr-3">
                            {% if product.user.role == 'Farmer' %}üë®‚Äçüåæ{% else %}üßë‚Äçüíº{% endif %}
                        </div>
                        <div>
                            <p class="font-semibold">{{ product.user.full_name }}</p>
                            <p class="text-gray-500 text-sm">{{ product.user.role }} from {{ product.user.region }}</p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-4">
                    {% if user.is_authenticated %}
                    <a href="https://wa.me/{{ product.user.phone_number|slugify }}" target="_blank" class="track-click block w-full bg-green-600 hover:bg-green-700 text-white text-center py-3 px-4 rounded-lg font-semibold mb-3" data-listing-id="{{ product.id }}">
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"></path>
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22c-5.523 0-10-4.477-10-10S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"></path>
                            </svg>
                            Contact via WhatsApp
                        </div>
                    </a>
                    <p class="text-xs text-gray-500 text-center">Contacting the seller directly via WhatsApp</p>
                    <!-- Share Button -->
                    <button onclick="toggleShareModal()" class="flex items-center gap-2 text-green-700 hover:text-green-800 font-semibold transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"                        >
                            <path fill-rule="evenodd" d="M15.75 4.5a3 3 0 1 1 .825 2.066l-8.421 4.679a3.002 3.002 0 0 1 0 1.51l8.421 4.679a3 3 0 1 1-.729 1.31l-8.421-4.678a3 3 0 1 1 0-4.132l8.421-4.679a3 3 0 0 1-.096-.755Z" clip-rule="evenodd" />
                          </svg>                       
                        <span>Share</span>
                    </button>

                    {% else %}
                    <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <p class="text-gray-700 mb-2">You need to login to contact this seller</p>
                        <a href="{% url 'login' %}" class="text-green-700 font-semibold hover:underline">Login now</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Similar Products</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for similar in similar_products %}
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="h-40 bg-gray-200">
                    {% if similar.photo %}
                    <img src="{{ similar.photo.url }}" alt="{{ similar.crop_name }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center">
                        <span class="text-gray-500 text-4xl">üåæ</span>
                    </div>
                    {% endif %}
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-semibold mb-2">{{ similar.crop_name }}</h3>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600">{{ similar.quantity }} {{ similar.unit }}</span>
                        <span class="font-bold text-green-700">‚Çµ{{ similar.price_per_unit }}</span>
                    </div>
                    <div class="flex items-center text-gray-500 mb-3">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm">{{ similar.region }}</span>
                    </div>
                    <a href="{% url 'product_detail' similar.slug similar.uid %}" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded">View Details</a>
                </div>
            </div>
            {% empty %}
            <div class="col-span-4">
                <p class="text-gray-500 text-center">No similar products found</p>
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Share Modal -->
<div id="shareModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
    <div id="modalContent"
         class="bg-white rounded-xl p-6 w-full max-w-sm shadow-xl transform scale-95 opacity-0 transition-all duration-300 space-y-4 relative">
        <button onclick="toggleShareModal()" class="absolute top-2 right-2 text-gray-400 hover:text-green-600 text-2xl font-bold">&times;</button>
        <h2 class="text-lg font-bold text-green-700 text-center">Share this Product</h2>
        <div class="flex flex-col gap-3">
            <a id="shareWhatsApp" target="_blank" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white rounded-lg py-2 px-4">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 32 32">
                <path d="M16.003 2.002c-7.732 0-14 6.267-14 14 0 2.472.645 4.889 1.873 7.006l-2.034 7.064 7.257-1.994c1.986 1.082 4.223 1.652 6.685 1.652 7.732 0 14-6.267 14-14s-6.268-14-14-14zM16.003 26.685c-2.03 0-4.012-.54-5.74-1.558l-.412-.244-4.303 1.182 1.165-4.17-.27-.439c-1.104-1.799-1.688-3.875-1.688-5.951 0-6.345 5.165-11.51 11.51-11.51s11.51 5.165 11.51 11.51c0 6.345-5.165 11.51-11.51 11.51zM21.375 19.49c-.297-.148-1.752-.865-2.025-.963-.273-.099-.472-.148-.672.148s-.773.963-.949 1.16c-.173.198-.347.223-.644.074s-1.256-.462-2.39-1.474c-.883-.788-1.48-1.758-1.653-2.056s-.018-.459.13-.607c.134-.132.298-.347.446-.521.148-.173.198-.297.297-.495.099-.198.05-.372-.025-.521s-.673-1.617-.922-2.222c-.243-.584-.49-.505-.672-.514s-.371-.01-.569-.01-.495.07-.755.347c-.259.277-.98.958-.98 2.335s1.003 2.703 1.142 2.889c.138.185 2.057 3.2 5.01 4.485.7.301 1.245.48 1.671.618.701.228 1.345.198 1.845.122.57-.085 1.733-.717 1.991-1.396.247-.682.247-1.276.173-1.405s-.272-.208-.569-.356z"/>
              </svg>
              Share via WhatsApp
            </a>
          
            <a id="shareTwitter" target="_blank" class="flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-black rounded-lg py-2 px-4">
                <!-- New Twitter (X) logo -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" d="M15.75 4.5a3 3 0 1 1 .825 2.066l-8.421 4.679a3.002 3.002 0 0 1 0 1.51l8.421 4.679a3 3 0 1 1-.729 1.31l-8.421-4.678a3 3 0 1 1 0-4.132l8.421-4.679a3 3 0 0 1-.096-.755Z" clip-rule="evenodd" />
                </svg>
                Share on X (Twitter)
              </a>
         
          
            <a id="shareFacebook" target="_blank" class="flex items-center gap-2 bg-blue-700 hover:bg-blue-800 text-white rounded-lg py-2 px-4">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 5 3.66 9.12 8.44 9.88v-6.99h-2.54v-2.89h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.23.2 2.23.2v2.44h-1.25c-1.24 0-1.63.77-1.63 1.56v1.88h2.77l-.44 2.89h-2.33v6.99C18.34 21.12 22 17 22 12z"/>
              </svg>
              Share on Facebook
            </a>
          
            <a id="shareEmail" target="_blank" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg py-2 px-4">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.11-.9-2-2-2zm0 2v.01L12 13 4 6.01V6h16zM4 18V8.99l8 6 8-6V18H4z"/>
              </svg>
              Share via Email
            </a>
          
                    <button onclick="copyLink()" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white rounded-lg py-2 px-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M10.5 3A1.501 1.501 0 0 0 9 4.5h6A1.5 1.5 0 0 0 13.5 3h-3Zm-2.693.178A3 3 0 0 1 10.5 1.5h3a3 3 0 0 1 2.694 1.678c.497.042.992.092 1.486.15 1.497.173 2.57 1.46 2.57 2.929V19.5a3 3 0 0 1-3 3H6.75a3 3 0 0 1-3-3V6.257c0-1.47 1.073-2.756 2.57-2.93.493-.057.989-.107 1.487-.15Z" clip-rule="evenodd" />
                          </svg>                 
                      Copy Link
                    </button>
            <p class="text-sm text-gray-500 text-center mt-4">Share this product with your friends and family!</p>
            <p id="copySuccess" class="text-sm text-green-600 hidden text-center">Link copied to clipboard!</p>
          </div>
         
    </div>
</div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const trackClickButton = document.querySelector('.track-click');
        if (trackClickButton) {
            trackClickButton.addEventListener('click', function() {
                const listingId = this.getAttribute('data-listing-id');
                // Send AJAX request to track click
                fetch('/track-whatsapp-click/' + listingId + '/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                }).then(response => {
                    console.log('WhatsApp click tracked');
                }).catch(error => {
                    console.error('Error tracking WhatsApp click:', error);
                });
            });
        }
    });
    function toggleShareModal() {
    const modal = document.getElementById('shareModal');
    const content = document.getElementById('modalContent');
    const isHidden = modal.classList.contains('hidden');

    if (isHidden) {
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    } else {
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // Fill share links
    const title = "{{ product.crop_name|escapejs }}";
    const url = "{{ request.build_absolute_uri }}";
    const encodedText = encodeURIComponent(`Check this out: ${title} - ${url}`);

    document.getElementById('shareWhatsApp').href = `https://wa.me/?text=${encodedText}`;
    document.getElementById('shareTwitter').href = `https://twitter.com/intent/tweet?text=${encodedText}`;
    document.getElementById('shareFacebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    document.getElementById('shareEmail').href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodedText}`;
}

function copyLink() {
    const url = "{{ request.build_absolute_uri }}";
    navigator.clipboard.writeText(url).then(() => {
        const msg = document.getElementById('copySuccess');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 2000);
    });
}
</script>
{% endblock %}